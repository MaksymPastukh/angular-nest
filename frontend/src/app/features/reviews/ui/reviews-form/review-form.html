<div class="mx-auto w-full max-w-3xl px-2 py-2">
  <!-- Форма отзыва -->
  <form (submit)="submitForm($event)" class="mb-12">
    <div
      class="rounded-lg border border-gray-200 bg-white p-6 transition-shadow focus-within:shadow-md"
    >
      <!-- Rating -->
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <span class="font-causten font-bold text-lg text-gray-900">Your rating</span>

          <app-ui-rating
            [value]="reviewsForm().value().rating"
            [stars]="5"
            [readonly]="false"
            [disabled]="!isAuthenticated() || isSubmitting()"
            (rateCommitted)="setRating($event ?? 5)"
            (cancelCommitted)="resetRating()"
          />
        </div>

        <div class="text-sm text-gray-500">{{ reviewsForm().value().rating }}/5</div>
      </div>

      <!-- Ошибка rating (если нужно показывать) -->
      @if (reviewsForm.rating().touched() && reviewsForm.rating().invalid()) {
        @if (reviewsForm.rating().errors().length > 0) {
          <div class="mt-2 text-xs text-red-600">
            {{ reviewsForm.rating().errors()[0].message }}
          </div>
        }
      }

      <!-- Text -->
      <div class="mt-5">
        <textarea
          [formField]="reviewsForm.text"
          placeholder="Напишите отзыв..."
          class="w-full resize-none bg-transparent text-sm text-gray-800 placeholder:text-gray-400 focus:outline-none"
          rows="4"
        ></textarea>

        <div class="mt-2 flex items-center justify-between text-xs text-gray-500">
          <div>
            @if (reviewsForm.text().touched() && reviewsForm.text().invalid()) {
              @if (reviewsForm.text().errors().length > 0) {
                <span class="text-red-600">{{ reviewsForm.text().errors()[0].message }}</span>
              }
            }
          </div>

          <div>{{ reviewsForm().value().text.length }}/1000</div>
        </div>
      </div>

      <div class="mt-3 flex justify-between">
        @if (isEditMode()) {
          <button
            type="button"
            (click)="deleteReview()"
            [disabled]="isSubmitting()"
            class="rounded-lg bg-red-600 font-causten cursor-pointer font-bold text-lg px-5 py-2 text-sm font-medium text-white transition hover:bg-red-700 active:scale-95 disabled:bg-red-300 disabled:cursor-not-allowed"
          >
            Delete review
          </button>
        }

        <button
          type="submit"
          [disabled]="!isAuthenticated() || isSubmitting() || reviewsForm().invalid()"
          [class]="{
            'rounded-lg bg-purple-600 font-causten cursor-pointer font-bold text-lg px-5 py-2 text-sm font-medium text-white transition hover:bg-purple-800 active:scale-95 disabled:bg-purple-300 disabled:cursor-not-allowed': true,
            'ml-auto': !isEditMode(),
          }"
        >
          @if (isSubmitting()) {
            <span class="animate-pulse">Sending…</span>
          } @else {
            <span>
              @if (isEditMode()) {
                Update review
              } @else {
                Post review
              }
            </span>
          }
        </button>
      </div>
    </div>
  </form>
</div>
