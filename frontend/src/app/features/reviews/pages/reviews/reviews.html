<div class="mx-auto w-full max-w-3xl px-2 py-2">
  @if (facade.isLoading()) {
    <div class="flex justify-center py-8">
      <div
        class="h-8 w-8 animate-spin rounded-full border-4 border-purple-600 border-t-transparent"
      ></div>
    </div>
  }

  @if (facade.error()) {
    <div class="mb-4 rounded-lg bg-red-50 p-4 text-red-800">
      {{ facade.error() }}
    </div>
  }

  @if (facade.hasProduct()) {
    <div class="flex justify-end gap-3 mb-5">
      <p-select
        [options]="sortOptions"
        [ngModel]="facade.sortBy()"
        (ngModelChange)="onSortChange($event)"
        placeholder="Sort"
        optionLabel="label"
        optionValue="value"
      />

      <p-select
        [options]="ratingFilterOptions"
        [ngModel]="facade.ratingFilter()"
        (ngModelChange)="onRatingFilterChange($event)"
        placeholder="Rating"
        optionLabel="label"
        optionValue="value"
      />
    </div>
    <app-review-ui-form
      [isAuthenticated]="authState.isAuthenticated()"
      [isSubmitting]="facade.isSubmitting()"
      [myReview]="facade.myReview()"
      (create)="onCreateReview($event)"
      (update)="onUpdateReview($event)"
      (delete)="onDeleteReview($event)"
    />
  }

  @if (facade.items().length > 0) {
    <div #reviewsTop class="space-y-4">
      @for (r of facade.items(); track r.id) {
        <div class="rounded-xl border border-gray-200 bg-white p-4 mt-5">
          <div class="flex items-center justify-between">
            <div class="font-medium text-shadow-lg/10 text-violet-500">{{ r.userName }}</div>
            <app-ui-rating [value]="r.rating" [readonly]="true" [stars]="5" />
          </div>
          <p class="mt-2 text-gray-700">{{ r.text }}</p>

          <div class="mt-3 flex justify-between items-end gap-3 text-sm text-gray-600">
            <span class="text-sm text-gray-500 dark:text-gray-400">
              {{ r.createdAt | date: 'dd.MM.yyyy' }}
            </span>
            <div class="flex flex-col items-end">
              <button
                type="button"
                class="inline-flex items-center gap-2 cursor-pointer"
                (click)="facade.toggleLike(r.id)"
              >
                <span class="text-sm text-gray-600">{{ r.likesCount }}</span>
                @if (r.isLiked) {
                  <app-ui-icon name="thumbs-up-fill" tone="default" />
                } @else {
                  <app-ui-icon name="thumbs-up" tone="muted" />
                }
              </button>
              @if (facade.myReview()?.id === r.id || facade.isAdmin()) {
                <button
                  type="button"
                  (click)="onDeleteReview(r.id)"
                  [disabled]="facade.isSubmitting()"
                  class="bg-trasparent rounded-lg cursor-pointer font-bold text-lg px-2 py-1 text-sm font-medium text-red transition"
                >
                  Delete review
                </button>
              }
            </div>
          </div>
        </div>
      }
    </div>
    @if (facade.total() > facade.pageSize()) {
      <div class="mt-6 flex justify-center">
        <p-paginator
          [first]="(facade.page() - 1) * facade.pageSize()"
          [rows]="facade.pageSize()"
          [totalRecords]="facade.total()"
          [rowsPerPageOptions]="[10, 20, 50]"
          (onPageChange)="onReviewsPageChange($event)"
        />
      </div>
    }
    @if (facade.canLoadMore()) {
      <div class="flex justify-center mt-8">
        <button
          type="button"
          (click)="onLoadMore()"
          class="rounded-lg bg-purple-600 px-6 py-2 text-white font-medium hover:bg-purple-700 active:scale-95"
        >
          Load more
        </button>
      </div>
    }
  } @else if (facade.isEmpty()) {
    <div class="py-12 text-center text-gray-500">
      <p class="text-lg">Отзывов пока нет</p>
      <p class="mt-2 text-sm">Будьте первым, кто оставит отзыв!</p>
    </div>
  }
</div>
