<p-accordion
  class="flex flex-col w-2xs"
  [(value)]="openedPanels"
  (valueChange)="onAccordionValueChange($event)"
  [multiple]="true"
>
  <p-accordion-panel value="0">
    <p-accordion-header>Filter</p-accordion-header>
    <p-accordion-content>
      @if (filterFacade.isLoading()) {
        <div class="text-center py-4 text-[#8a8989]">
          <p>Loading filters...</p>
        </div>
      }

      @if (filterFacade.error()) {
        <div class="text-center py-4 text-red-500">
          <p>{{ filterFacade.error() }}</p>
          <button
            (click)="reloadFilterData()"
            class="mt-2 cursor-pointer text-purple-600 hover:text-purple-800"
          >
            Retry
          </button>
        </div>
      }

      @if (!filterFacade.isLoading() && !filterFacade.error()) {
        <!-- Кнопки категорий -->
        @for (categoryName of filterFacade.productTypes(); track $index) {
          <div class="category-item-wrapper" (pointerleave)="onCategoryLeave()">
            <button
              #categoryBtn
              type="button"
              class="w-full text-left mt-2 px-2 py-1 rounded-lg font-causten text-lg font-semibold text-[#8a8989] cursor-pointer bg-white hover:text-[#8a33fd] hover:bg-[rgba(168,85,247,0.08)] flex items-center justify-between group"
              [class.active]="openCategoryDropdown() === categoryName"
              (pointerenter)="onCategoryHover(categoryName, categoryBtn)"
            >
              <span>{{ categoryName }}</span>
              <svg
                class="w-4 h-4 text-[#8a8989] group-hover:text-[#8a33fd] transition-colors duration-300 ease-in-out"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </button>
          </div>
        }

        <!-- Глобальный dropdown для категорий (рендерится в body через CDK Overlay) -->
        <app-brands-dropdown
          [anchor]="categoryAnchor()"
          [brands]="filterFacade.previewBrandsSafe()"
          [isLoading]="filterFacade.previewIsLoading()"
          [isOpen]="!!openCategoryDropdown()"
          (brandSelect)="onBrandSelect(openCategoryDropdown(), $event)"
          (dropdownEnter)="onDropdownEnter('category')"
          (dropdownLeave)="onDropdownLeave('category')"
        />
      }
    </p-accordion-content>
  </p-accordion-panel>

  <p-accordion-panel value="1">
    <p-accordion-header>Price</p-accordion-header>
    <p-accordion-content>
      <div class="flex flex-col items-center mt-[42px]">
        <p-slider
          class="w-[236px]"
          [(ngModel)]="priceRangeValues"
          [min]="min"
          [max]="max"
          [range]="true"
          (onChange)="onPriceChange($event.values)"
        />
        <div class="flex gap-[30px] font-medium text-base mt-[30px] mb-[35px]">
          <div class="relative">
            <span
              class="absolute left-5 top-1/2 -translate-y-1/2 text-[#807d7e] pointer-events-none"
              >$</span
            >
            <input
              type="number"
              [(ngModel)]="priceRangeValues[0]"
              [min]="min"
              [max]="priceRangeValues[1]"
              (input)="onMinPriceInput($event)"
              (blur)="validatePriceRange()"
              class="border border-[#bebcbd] flex justify-center items-center rounded-lg w-[97px] h-[32px] text-[#807d7e] text-center pl-7 pr-2 outline-none focus:border-[#a855f7] focus:ring-1 focus:ring-[#a855f7] transition-all"
              placeholder="Min"
            />
          </div>
          <div class="relative">
            <span
              class="absolute left-5 top-1/2 -translate-y-1/2 text-[#807d7e] pointer-events-none"
              >$</span
            >
            <input
              type="number"
              [(ngModel)]="priceRangeValues[1]"
              [min]="priceRangeValues[0]"
              [max]="max"
              (input)="onMaxPriceInput($event)"
              (blur)="validatePriceRange()"
              class="border border-[#bebcbd] flex justify-center items-center rounded-lg w-[97px] h-[32px] text-[#807d7e] text-center pl-6 pr-2 outline-none focus:border-[#a855f7] focus:ring-1 focus:ring-[#a855f7] transition-all"
              placeholder="Max"
            />
          </div>
        </div>
      </div>
    </p-accordion-content>
  </p-accordion-panel>
  <p-accordion-panel value="2">
    <p-accordion-header>Colors</p-accordion-header>
    <p-accordion-content>
      @if (filterFacade.isLoading()) {
        <div class="text-center py-4 text-[#8a8989]">
          <p>Loading filters...</p>
        </div>
      }

      @if (filterFacade.error()) {
        <div class="text-center py-4 text-red-500">
          <p>{{ filterFacade.error() }}</p>
        </div>
      }

      <div class="grid grid-cols-4 gap-4 mt-[20px] mb-[20px] w-full">
        @for (color of filterFacade.colors(); track color.name) {
          <button
            type="button"
            class="flex flex-col items-center space-y-1 focus:outline-none cursor-pointer group"
            (click)="selectColor(color.name)"
            [attr.aria-label]="'Select ' + color.name + ' color'"
            [attr.aria-pressed]="filterFacade.isColorsSelected(color.name)"
          >
            <div
              [class]="
                'w-[36px] h-[36px] rounded-xl transition-all duration-200 relative ' +
                (filterFacade.isColorsSelected(color.name)
                  ? 'shadow-[inset_0_2px_4px_rgba(0,0,0,0.3)] scale-95'
                  : 'shadow-[0_1px_3px_rgba(0,0,0,0.1)]')
              "
              [style.background-color]="color.value"
              [style.border]="
                '0.97px solid ' +
                (filterFacade.isColorsSelected(color.name) ? '#f4f1f1' : '#f4f1f1')
              "
            >
              @if (filterFacade.isColorsSelected(color.name)) {
                <div class="absolute inset-0 flex items-center justify-center">
                  <svg
                    class="w-5 h-5"
                    [class.text-gray-800]="color.value === '#ffffff'"
                    [class.text-white]="color.value !== '#ffffff'"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="3"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                </div>
              }
            </div>
            <span class="text-sm text-[#8a8989] font-causten font-bold transition-colors">{{
              color.name
            }}</span>
          </button>
        }
      </div>
    </p-accordion-content>
  </p-accordion-panel>
  <p-accordion-panel value="3">
    <p-accordion-header>Sizes</p-accordion-header>
    <p-accordion-content>
      @if (filterFacade.isLoading()) {
        <div class="text-center py-4 text-[#8a8989]">
          <p>Loading filters...</p>
        </div>
      }

      @if (filterFacade.error()) {
        <div class="text-center py-4 text-red-500">
          <p>{{ filterFacade.error() }}</p>
        </div>
      }

      <div class="grid grid-cols-3 mt-[20px] mb-[20px] gap-5 w-full">
        @for (size of filterFacade.sizes(); track $index) {
          <button
            type="button"
            (click)="toggleSize(size)"
            class="border border-gray-400 leading-none font-coresans font-bold cursor-pointer flex items-center justify-center rounded-lg h-[32px] text-sm transition-all duration-200 hover:border-purple-500"
            [class.bg-purple-600]="filterFacade.isSizesSelected(size)"
            [class.text-white]="filterFacade.isSizesSelected(size)"
            [class.text-gray-600]="!filterFacade.isSizesSelected(size)"
            [class.bg-white]="!filterFacade.isSizesSelected(size)"
            [attr.aria-label]="'Select size ' + size"
            [attr.aria-pressed]="filterFacade.isSizesSelected(size)"
          >
            {{ size }}
          </button>
        }
      </div>
    </p-accordion-content>
  </p-accordion-panel>
  <p-accordion-panel value="4">
    <p-accordion-header>Dress Styles</p-accordion-header>
    <p-accordion-content>
      @if (filterFacade.isLoading()) {
        <div class="text-center py-4 text-[#8a8989]">
          <p>Loading filters...</p>
        </div>
      }

      @if (filterFacade.error()) {
        <div class="text-center py-4 text-red-500">
          <p>{{ filterFacade.error() }}</p>
        </div>
      }

      @for (styleName of filterFacade.dressStyles(); track $index) {
        <div class="category-item-wrapper" (pointerleave)="onStyleLeave()">
          <button
            #styleBtn
            type="button"
            class="w-full text-left mt-2 px-2 py-1 rounded-lg text-lg font-causten font-bold text-[#8a8989] cursor-pointer bg-white hover:text-[#8a33fd] hover:bg-[rgba(168,85,247,0.08)] flex items-center justify-between group"
            [class.active]="openStyleDropdown() === styleName"
            (pointerenter)="onStyleHover(styleName, styleBtn)"
          >
            <span>{{ styleName }}</span>
            <svg
              class="w-4 h-4 text-[#8a8989] group-hover:text-[#8a33fd] transition-colors duration-300 ease-in-out"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              />
            </svg>
          </button>
        </div>
      }

      <app-brands-dropdown
        [anchor]="styleAnchor()"
        [brands]="filterFacade.previewBrandsSafe()"
        [isLoading]="filterFacade.previewIsLoading()"
        [isOpen]="!!openStyleDropdown()"
        (brandSelect)="onStyleBrandSelect(openStyleDropdown(), $event)"
        (dropdownEnter)="onDropdownEnter('style')"
        (dropdownLeave)="onDropdownLeave('style')"
      />
    </p-accordion-content>
  </p-accordion-panel>
</p-accordion>
