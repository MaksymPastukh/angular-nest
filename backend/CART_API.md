# API Документация для корзины покупок (Cart)

## Обзор

Модуль Cart предоставляет полноценную систему управления корзиной покупок с поддержкой:
- Добавления товаров с выбором размера
- Обновления количества
- Удаления товаров
- Автоматического пересчета итогов
- Очистки корзины

**Все endpoints требуют авторизации (JWT токен).**

---

## Структура Cart

```typescript
{
  "id": "string",
  "items": [
    {
      "productId": "string",
      "productTitle": "string",
      "productImage": "string",
      "price": number,
      "quantity": number,
      "size": "string",
      "color": "string",
      "addedAt": "date"
    }
  ],
  "totalPrice": number,
  "totalItems": number,
  "isEmpty": boolean,
  "createdAt": "date",
  "updatedAt": "date"
}
```

---

## API Endpoints

### 1. Получить корзину
**GET** `/api/cart`

**Требуется авторизация**: Да (JWT)

**Response:**
```json
{
  "id": "cart123",
  "items": [
    {
      "productId": "prod123",
      "productTitle": "Футболка Nike",
      "productImage": "/images/products/nike.jpg",
      "price": 1999,
      "quantity": 2,
      "size": "M",
      "color": "Black",
      "addedAt": "2026-01-22T10:00:00.000Z"
    }
  ],
  "totalPrice": 3998,
  "totalItems": 2,
  "isEmpty": false,
  "createdAt": "2026-01-22T09:00:00.000Z",
  "updatedAt": "2026-01-22T10:00:00.000Z"
}
```

---

### 2. Получить количество товаров
**GET** `/api/cart/count`

**Требуется авторизация**: Да (JWT)

**Response:**
```json
{
  "count": 5
}
```

**Использование:** Отображение количества товаров на иконке корзины в header.

---

### 3. Добавить товар в корзину
**POST** `/api/cart`

**Требуется авторизация**: Да (JWT)

**Body:**
```json
{
  "productId": "6964f6f7788707f3110fa9f0",
  "size": "M",
  "quantity": 1
}
```

**Response:** Обновленная корзина (см. структуру выше)

**Логика:**
- Если товар с таким `productId` и `size` уже есть → количество увеличивается
- Если товара нет → добавляется новый элемент

**Валидация:**
- `productId` - обязательный, должен существовать в БД
- `size` - обязательный, должен быть доступен для продукта
- `quantity` - обязательный, минимум 1

---

### 4. Обновить количество товара
**PATCH** `/api/cart/item`

**Требуется авторизация**: Да (JWT)

**Body:**
```json
{
  "productId": "6964f6f7788707f3110fa9f0",
  "size": "M",
  "quantity": 3
}
```

**Response:** Обновленная корзина

**Использование:** Изменение количества через "+" и "-" кнопки.

---

### 5. Удалить товар из корзины
**DELETE** `/api/cart/item`

**Требуется авторизация**: Да (JWT)

**Body:**
```json
{
  "productId": "6964f6f7788707f3110fa9f0",
  "size": "M"
}
```

**Response:** Обновленная корзина

**Важно:** Удаляется конкретная комбинация `productId + size`.

---

### 6. Очистить корзину
**DELETE** `/api/cart`

**Требуется авторизация**: Да (JWT)

**Response:** Пустая корзина

**Использование:** После оформления заказа или по желанию пользователя.

---

## Особенности реализации

### 1. Один товар - разные размеры

Товар с одним `productId`, но разными размерами хранится как **отдельные элементы**:

```json
{
  "items": [
    {
      "productId": "prod123",
      "size": "M",
      "quantity": 2
    },
    {
      "productId": "prod123",  // Тот же продукт
      "size": "L",              // Но другой размер
      "quantity": 1
    }
  ]
}
```

### 2. Автоматический пересчет

При любом изменении корзины автоматически пересчитываются:
- `totalItems` - общее количество товаров (сумма всех quantity)
- `totalPrice` - общая стоимость (сумма price * quantity)
- `isEmpty` - флаг пустой корзины

### 3. Сохранение информации о продукте

При добавлении в корзину сохраняется:
- `productTitle` - название (для быстрого отображения)
- `productImage` - изображение
- `price` - цена **на момент добавления**
- `color` - цвет продукта

Это защищает от изменения цен и удаления продуктов.

### 4. Уникальная корзина для каждого пользователя

Корзина привязана к `userId` с уникальным индексом → один пользователь = одна корзина.

---

## Примеры использования

### Frontend (Angular/TypeScript)

```typescript
// Добавить товар
addToCart(productId: string, size: string) {
  return this.http.post('/api/cart', { productId, size, quantity: 1 });
}

// Получить корзину
getCart() {
  return this.http.get('/api/cart');
}

// Увеличить количество
incrementQuantity(productId: string, size: string, currentQuantity: number) {
  return this.http.patch('/api/cart/item', { 
    productId, 
    size, 
    quantity: currentQuantity + 1 
  });
}

// Удалить товар
removeItem(productId: string, size: string) {
  return this.http.delete('/api/cart/item', { 
    body: { productId, size } 
  });
}

// Очистить корзину
clearCart() {
  return this.http.delete('/api/cart');
}
```

---

## Миграция со старой структуры

Если у вас была корзина на клиенте (localStorage), миграция простая:

```typescript
// Старая корзина (localStorage)
const oldCart = JSON.parse(localStorage.getItem('cart') || '[]');

// Миграция на backend
for (const item of oldCart) {
  await cartService.addToCart({
    productId: item.productId,
    size: item.size,
    quantity: item.quantity
  });
}

// Очистить localStorage
localStorage.removeItem('cart');
```

---

## Безопасность

1. **JWT авторизация** - все endpoints защищены
2. **Валидация данных** - через class-validator
3. **Проверка существования продукта** - перед добавлением
4. **Проверка доступности размера** - размер должен быть в `product.size[]`
5. **Изоляция данных** - пользователь видит только свою корзину

---

## Оптимизация

1. **Индексы MongoDB:**
   - `{ userId: 1 }` - быстрый поиск корзины пользователя
   
2. **Денормализация:**
   - Хранение `productTitle`, `productImage`, `price` в корзине
   - Уменьшает количество запросов к Products

3. **Один документ на пользователя:**
   - Вся корзина в одном документе
   - Минимум операций с БД

---

## Типичные сценарии

### Сценарий 1: Добавление товара

```
1. Пользователь выбирает размер и нажимает "В корзину"
2. POST /api/cart { productId, size, quantity: 1 }
3. Backend:
   - Проверяет продукт
   - Проверяет размер
   - Добавляет или увеличивает quantity
   - Пересчитывает итоги
4. Возвращает обновленную корзину
5. Frontend обновляет иконку корзины (badge с количеством)
```

### Сценарий 2: Оформление заказа

```
1. Пользователь на странице корзины нажимает "Оформить заказ"
2. Frontend отправляет данные корзины в модуль Orders
3. После успешного создания заказа:
   DELETE /api/cart (очистить корзину)
4. Редирект на страницу "Заказ оформлен"
```

### Сценарий 3: Синхронизация при входе

```
1. Пользователь логинится
2. GET /api/cart (получить корзину с сервера)
3. Если в localStorage была корзина → мигрировать на backend
4. Отобразить актуальную корзину
```

---

## Права доступа

- **Получение корзины**: Авторизованный пользователь (своя корзина)
- **Добавление товара**: Авторизованный пользователь
- **Обновление количества**: Авторизованный пользователь
- **Удаление товара**: Авторизованный пользователь
- **Очистка корзины**: Авторизованный пользователь

**Администраторы НЕ могут управлять чужими корзинами** (приватность).
